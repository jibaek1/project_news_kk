<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssr.newskuku.domain.login.mapper.UserCategoryMapper">

    <!-- Result Map -->
    <resultMap id="userCategoryResultMap" type="user_category">
        <id property="userCategoryId" column="user_category_id"/>
        <result property="userId" column="user_id"/>
        <result property="categoryId" column="category_id"/>
        <result property="createdAt" column="created_at"/>
        <result property="modifiedAt" column="modified_at"/>
    </resultMap>

    <!-- 사용자의 관심 카테고리 목록 조회 -->
    <select id="findByUserId" resultMap="userCategoryResultMap">
        SELECT user_category_id,
        user_id,
        category_id,
        created_at,
        modified_at
        FROM user_category
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>

    <!-- 사용자의 관심 카테고리 ID 목록 조회 -->
    <select id="findCategoryIdsByUserId" resultType="long">
        SELECT category_id
        FROM user_category
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
    </select>

    <!-- 사용자의 관심 카테고리 이름 목록 조회 -->
    <select id="findCategoryNamesByUserId" resultType="string">
        SELECT c.category_name
        FROM user_category uc
        INNER JOIN category c ON uc.category_id = c.category_id
        WHERE uc.user_id = #{userId}
        ORDER BY uc.created_at DESC
    </select>

    <!-- 새 관심 카테고리 추가 -->
    <insert id="insert" useGeneratedKeys="true" keyProperty="userCategoryId" keyColumn="user_category_id">
        INSERT INTO user_category (user_id, category_id, created_at, modified_at)
        VALUES (#{userId}, #{categoryId}, NOW(), NOW())
    </insert>

    <!-- 여러 관심 카테고리 일괄 추가 -->
    <insert id="insertBatch">
        INSERT INTO user_category (user_id, category, created_at, modified_at)
        VALUES
        <foreach collection="categories" item="category" separator=",">
            (#{userId}, #{category}, NOW(), NOW())
        </foreach>
    </insert>

    <!-- 카테고리 이름으로 여러 관심 카테고리 일괄 추가 -->
    <insert id="insertBatchByNames">
        INSERT INTO user_category (user_id, category_id, created_at, modified_at)
        SELECT #{userId}, c.category_id, NOW(), NOW()
        FROM category c
        WHERE c.category_name IN
        <foreach collection="categoryNames" item="name" open="(" separator="," close=")">
            #{name}
        </foreach>
    </insert>

    <!-- 특정 사용자-카테고리 관계 삭제 -->
    <delete id="delete">
        DELETE FROM user_category
        WHERE user_category_id = #{userCategoryId}
    </delete>

    <!-- 사용자의 특정 카테고리 관심 삭제 -->
    <delete id="deleteByUserIdAndCategoryId">
        DELETE FROM user_category
        WHERE user_id = #{userId}
        AND category_id = #{categoryId}
    </delete>

    <!-- 사용자의 모든 관심 카테고리 삭제 -->
    <delete id="deleteAllByUserId">
        DELETE FROM user_category
        WHERE user_id = #{userId}
    </delete>

    <!-- 사용자가 특정 카테고리에 관심이 있는지 확인 -->
    <select id="existsByUserIdAndCategoryId" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM user_category
        WHERE user_id = #{userId}
        AND category_id = #{categoryId}
    </select>

    <!-- 특정 카테고리에 관심 있는 사용자 ID 목록 조회 -->
    <select id="findUserIdsByCategoryId" resultType="long">
        SELECT user_id
        FROM user_category
        WHERE category_id = #{categoryId}
        ORDER BY created_at DESC
    </select>

    <!-- 특정 카테고리에 관심 있는 사용자 수 조회 -->
    <select id="countUsersByCategoryId" resultType="int">
        SELECT COUNT(*)
        FROM user_category
        WHERE category_id = #{categoryId}
    </select>

    <!-- 카테고리별 관심 사용자 수 통계 -->
    <select id="getCategoryStatistics" resultType="map">
        SELECT c.category_id,
        c.category_name,
        COUNT(uc.user_id) AS user_count
        FROM category c
        LEFT JOIN user_category uc ON c.category_id = uc.category_id
        GROUP BY c.category_id, c.category_name
        ORDER BY user_count DESC, c.category_name
    </select>

    <!-- 사용자의 관심 카테고리 수 조회 -->
    <select id="countCategoriesByUserId" resultType="int">
        SELECT COUNT(*)
        FROM user_category
        WHERE user_id = #{userId}
    </select>

    <!-- 여러 카테고리 중 하나라도 관심 있는 사용자 ID 목록 조회 -->
    <select id="findUserIdsByAnyCategoryIds" resultType="long">
        SELECT DISTINCT user_id
        FROM user_category
        WHERE category_id IN
        <foreach collection="categoryIds" item="categoryId" open="(" separator="," close=")">
            #{categoryId}
        </foreach>
        ORDER BY user_id
    </select>

    <!-- 특정 사용자들의 공통 관심 카테고리 조회 -->
    <select id="findCommonCategoryIds" resultType="long">
        SELECT category_id
        FROM user_category
        WHERE user_id IN
        <foreach collection="userIds" item="userId" open="(" separator="," close=")">
            #{userId}
        </foreach>
        GROUP BY category_id
        HAVING COUNT(DISTINCT user_id) = #{userIds.size()}
        ORDER BY category_id
    </select>

    <!-- 최근 추가된 사용자 관심 카테고리 조회 -->
    <select id="findRecentByUserId" resultMap="userCategoryResultMap">
        SELECT user_category_id,
        user_id,
        category_id,
        created_at,
        modified_at
        FROM user_category
        WHERE user_id = #{userId}
        ORDER BY created_at DESC
        LIMIT #{limit}
    </select>

</mapper>